<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Track your wrestling training journey">
  <meta name="theme-color" content="#ea580c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Wrestling">
  
  <title>Wrestling Journey</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="icon.svg">
  
  <!-- Custom Stylesheet (UPGRADED) -->
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <div id="root"></div>
  
  <script type="module" src="db.js"></script>
  
  <script type="module">
    // Import all necessary functions from the new db.js module
    import {
      getPractices,
      addPractice as dbAddPractice,
      deletePractice as dbDeletePractice,
      getProfile,
      setProfile,
      clearAllData,
      ALL_BADGES,
      checkBadges as dbCheckBadges,
      PHASES,
      getPhase as dbGetPhase
    } from './db.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      const root = document.getElementById('root');
      let practices = [];
      let profile = {};
      let currentTab = 'dashboard';

      // --- RENDER FUNCTION ---
      async function render() {
        practices = await getPractices();
        profile = await getProfile();

        const { current: currentPhase, next: nextPhase } = dbGetPhase(practices.length);

        // Update profile if a badge was earned
        const updatedProfile = dbCheckBadges(practices, profile);
        if (updatedProfile) {
            profile = updatedProfile;
            await setProfile(profile);
        }

        const stats = {
          totalPractices: practices.length,
          avgIntensity: practices.length ? (practices.reduce((sum, p) => sum + (p.intensity || 0), 0) / practices.length).toFixed(1) : '0.0',
          totalTime: practices.reduce((sum, p) => sum + (p.duration || 0), 0),
          lastPracticeDate: practices.length ? new Date(practices.slice(-1)[0].date).toLocaleDateString() : 'N/A'
        };

        const practiceCount = practices.length;
        const earnedBadges = (profile.earnedBadges || []).map(badge => ({ ...badge, id: String(badge.id) }))
          .sort((a, b) => new Date(a.earnedDate) - new Date(b.earnedDate));
        const latestBadges = earnedBadges.slice(-3).reverse();

        const milestoneBadges = ALL_BADGES
          .filter(badge => typeof badge.milestone === 'number')
          .sort((a, b) => a.milestone - b.milestone);

        const nextMilestone = milestoneBadges.find(badge => badge.milestone > practiceCount) || null;
        const previousMilestone = [...milestoneBadges]
          .reverse()
          .find(badge => badge.milestone <= practiceCount) || null;

        const startMilestoneValue = previousMilestone ? previousMilestone.milestone : 0;
        const targetMilestoneValue = nextMilestone ? nextMilestone.milestone : (previousMilestone ? previousMilestone.milestone : practiceCount || 1);
        const milestoneDenominator = Math.max(1, targetMilestoneValue - startMilestoneValue);
        const progressPercent = nextMilestone
          ? Math.min(100, Math.max(0, Math.round(((practiceCount - startMilestoneValue) / milestoneDenominator) * 100)))
          : 100;
        const sessionsRemaining = nextMilestone ? Math.max(0, targetMilestoneValue - practiceCount) : 0;
        const sessionsLabel = sessionsRemaining === 1 ? 'session' : 'sessions';
        const milestoneUnit = nextMilestone && nextMilestone.milestone === 1 ? 'practice' : 'practices';
        const nextMilestoneLabel = nextMilestone
          ? `${nextMilestone.milestone} ${milestoneUnit} Â· ${nextMilestone.name}`
          : 'Veteran status â€” keep sharpening your edge.';
        const totalHours = (stats.totalTime / 60).toFixed(1);
        const lastPractice = practices.length ? practices[practices.length - 1] : null;

        root.innerHTML = `
          <div class="app">
            <header class="hero">
              <div class="hero-copy">
                <p class="hero-tag">Pixel 8 ready Â· Offline Â· Dark mode only</p>
                <h1 class="title">Wrestling Journey</h1>
                <p class="hero-subtitle">Track the grind honestly. Wrestling takes years, consistency wins.</p>
              </div>
              <button class="button secondary hero-action" id="hero-log-btn">Log today</button>
            </header>

            <nav class="tabs" role="tablist">
              <button id="tab-dashboard" class="tab ${currentTab === 'dashboard' ? 'active' : ''}" role="tab">Dashboard</button>
              <button id="tab-log" class="tab ${currentTab === 'log' ? 'active' : ''}" role="tab">Log</button>
              <button id="tab-history" class="tab ${currentTab === 'history' ? 'active' : ''}" role="tab">History</button>
              <button id="tab-badges" class="tab ${currentTab === 'badges' ? 'active' : ''}" role="tab">Badges</button>
              <button id="tab-guide" class="tab ${currentTab === 'guide' ? 'active' : ''}" role="tab">Guide</button>
              <button id="tab-settings" class="tab ${currentTab === 'settings' ? 'active' : ''}" role="tab">Settings</button>
            </nav>

            <main class="panels">
              <!-- Dashboard -->
              <section id="section-dashboard" class="section ${currentTab === 'dashboard' ? 'active' : ''}">
                <article class="panel">
                  <div class="panel-header">
                    <div>
                      <p class="eyebrow">Current Phase</p>
                      <h2>${currentPhase.name}</h2>
                    </div>
                    <span class="phase-chip">${stats.totalPractices} logged</span>
                  </div>
                  <p class="panel-subtitle">Next milestone: ${nextMilestoneLabel}</p>
                  <div class="progress-summary">
                    <div class="progress-visual">
                      <div class="progress-bar-outer" aria-hidden="true">
                        <div class="progress-bar-inner" style="width: ${progressPercent}%;"></div>
                      </div>
                      <div class="progress-label">${nextMilestone ? `${practiceCount - startMilestoneValue} of ${milestoneDenominator} practices toward ${nextMilestone.name}` : `${practiceCount} practices logged`}</div>
                    </div>
                    <div class="progress-details">
                      <p class="progress-count">${practiceCount}${nextMilestone ? ` / ${nextMilestone.milestone}` : ''} practices logged</p>
                      <p class="progress-note">${nextMilestone ? (sessionsRemaining > 0 ? `${sessionsRemaining} more ${sessionsLabel} until ${nextMilestone.name}.` : 'You hit this milestone. Stay humble and keep the reps coming.') : 'You carved out your own pace. Keep the story going.'}</p>
                      <p class="progress-last">${lastPractice ? `Last logged: ${new Date(lastPractice.date).toLocaleDateString()} Â· ${lastPractice.type}` : 'You have not logged a practice yet. Start todayâ€”no fluff, just work.'}</p>
                    </div>
                  </div>
                  <div class="dashboard-actions">
                    <button class="button" data-switch-to="log">Add practice</button>
                    <button class="button ghost" data-switch-to="history">View history</button>
                  </div>
                </article>

                <article class="panel">
                  <div class="panel-header">
                    <h3>Consistency stats</h3>
                  </div>
                  <div class="stats-grid">
                    <div class="stat-card">
                      <p class="stat-label">Practices</p>
                      <p class="stat-value">${stats.totalPractices}</p>
                    </div>
                    <div class="stat-card">
                      <p class="stat-label">Hours logged</p>
                      <p class="stat-value">${isNaN(totalHours) ? '0.0' : totalHours}</p>
                    </div>
                    <div class="stat-card">
                      <p class="stat-label">Avg intensity</p>
                      <p class="stat-value">${stats.avgIntensity}</p>
                    </div>
                    <div class="stat-card">
                      <p class="stat-label">Last entry</p>
                      <p class="stat-value">${stats.lastPracticeDate}</p>
                    </div>
                  </div>
                </article>

                <article class="panel">
                  <div class="panel-header">
                    <div>
                      <h3>Achievements</h3>
                      <p class="panel-subtitle">Milestones and focus badges â€” what you earned and why it matters.</p>
                    </div>
                    <button class="button-link" data-switch-to="badges">See all</button>
                  </div>
                  <div class="badge-shelf">
                    ${latestBadges.length ? latestBadges.map(badge => {
                      const badgeInfo = ALL_BADGES.find(item => item.id === badge.id);
                      return `
                        <div class="badge-token">
                          <span class="badge-icon">${badgeInfo ? badgeInfo.icon : 'ðŸ¥‹'}</span>
                          <div class="badge-copy">
                            <p class="badge-name">${badgeInfo ? badgeInfo.name : 'Badge'}</p>
                            ${badgeInfo && badgeInfo.description ? `<p class="badge-desc">${badgeInfo.description}</p>` : ''}
                            <p class="badge-meta">Practice #${badge.practiceNumber} Â· ${new Date(badge.earnedDate).toLocaleDateString()}</p>
                          </div>
                        </div>
                      `;
                    }).join('') : '<p class="empty">Log consistently to earn your first achievement.</p>'}
                  </div>
                </article>
              </section>

              <!-- Log Practice -->
              <section id="section-log" class="section ${currentTab === 'log' ? 'active' : ''}">
                <article class="panel">
                  <div class="panel-header">
                    <div>
                      <h2>Log today\'s work</h2>
                      <p class="panel-subtitle">It should take under a minute. Be honestâ€”progress is earned slowly.</p>
                    </div>
                  </div>
                  <form id="practice-form" class="form-grid">
                    <div class="form-card">
                      <h3>Session basics</h3>
                      <div class="field">
                        <label for="practice-date">Date</label>
                        <input id="practice-date" type="date" class="input" value="${new Date().toISOString().split('T')[0]}">
                      </div>
                      <div class="field">
                        <label for="practice-type">Session type</label>
                        <select id="practice-type" class="input">
                          <option value="mixed">Mixed work</option>
                          <option value="technique">Technique focus</option>
                          <option value="live">Live wrestling</option>
                          <option value="conditioning">Conditioning</option>
                          <option value="competition">Competition</option>
                          <option value="open-mat">Open mat</option>
                        </select>
                      </div>
                      <div class="field">
                        <span class="label">Duration presets</span>
                        <div class="chip-row">
                          <button type="button" class="chip" data-duration="60">60 min</button>
                          <button type="button" class="chip" data-duration="90">90 min</button>
                          <button type="button" class="chip" data-duration="120">120 min</button>
                        </div>
                      </div>
                      <div class="field">
                        <label for="practice-duration">Manual duration (minutes)</label>
                        <input id="practice-duration" type="number" min="1" inputmode="numeric" class="input" placeholder="75">
                      </div>
                    </div>

                    <div class="form-card">
                      <h3>How did it feel?</h3>
                      <div class="field field-slider">
                        <label for="practice-intensity">Intensity</label>
                        <div class="slider-wrap">
                          <input id="practice-intensity" type="range" min="1" max="10" value="5" class="input range">
                          <span id="intensity-value" class="slider-value">5</span>
                        </div>
                      </div>
                      <div class="field field-slider">
                        <label for="practice-physical">Physical feel</label>
                        <div class="slider-wrap">
                          <input id="practice-physical" type="range" min="1" max="10" value="5" class="input range">
                          <span id="physical-value" class="slider-value">5</span>
                        </div>
                      </div>
                      <div class="field field-slider">
                        <label for="practice-mental">Mental feel</label>
                        <div class="slider-wrap">
                          <input id="practice-mental" type="range" min="1" max="10" value="5" class="input range">
                          <span id="mental-value" class="slider-value">5</span>
                        </div>
                      </div>
                    </div>

                    <div class="form-card">
                      <h3>Notes for future you</h3>
                      <div class="field">
                        <label for="practice-notes">Key takeaways</label>
                        <textarea id="practice-notes" class="input textarea" rows="4" placeholder="What clicked? What felt off? Be specific so future sessions improve."></textarea>
                      </div>
                    </div>

                    <div class="form-actions">
                      <button type="submit" class="button">Save practice</button>
                      <button type="button" class="button ghost" data-switch-to="dashboard">Cancel</button>
                    </div>
                  </form>
                </article>
              </section>

              <!-- History -->
              <section id="section-history" class="section ${currentTab === 'history' ? 'active' : ''}">
                <article class="panel">
                  <div class="panel-header">
                    <div>
                      <h2>Practice history</h2>
                      <p class="panel-subtitle">Scroll through the work. No shortcuts, just honest reps.</p>
                    </div>
                    <span class="phase-chip subtle">${practices.length} logged</span>
                  </div>
                  ${practices.length ? `
                    <ul id="practice-list" class="practice-list">
                      ${practices.slice().reverse().map(p => `
                        <li class="practice-card" data-id="${p.id}">
                          <div class="practice-card-header">
                            <span class="practice-type">${p.type}</span>
                            <time class="practice-date">${new Date(p.date).toLocaleDateString()}</time>
                          </div>
                          <p class="practice-notes">${p.notes}</p>
                          <div class="practice-metrics">
                            ${p.duration ? `<span>${p.duration} min</span>` : ''}
                            ${p.intensity ? `<span>Intensity ${p.intensity}/10</span>` : ''}
                            ${typeof p.physical === 'number' ? `<span>Physical ${p.physical}/10</span>` : ''}
                            ${typeof p.mental === 'number' ? `<span>Mental ${p.mental}/10</span>` : ''}
                          </div>
                          <button class="delete-btn" data-id="${p.id}">Delete</button>
                        </li>
                      `).join('')}
                    </ul>
                  ` : '<div class="empty">No sessions logged yet. Start with today\'s practice.</div>'}
                </article>
              </section>

              <!-- Badges -->
              <section id="section-badges" class="section ${currentTab === 'badges' ? 'active' : ''}">
                <article class="panel">
                  <div class="panel-header">
                    <div>
                      <h2>Earned badges</h2>
                      <p class="panel-subtitle">Consistency over hype. Each badge marks a real milestone.</p>
                    </div>
                  </div>
                  <div class="badge-feed">
                    ${earnedBadges.length ? earnedBadges.map(badge => {
                      const badgeInfo = ALL_BADGES.find(item => item.id === badge.id);
                      return `
                        <div class="badge-card earned">
                          <span class="badge-icon">${badgeInfo ? badgeInfo.icon : 'ðŸ¥‹'}</span>
                          <div class="badge-copy">
                            <h3>${badgeInfo ? badgeInfo.name : 'Badge'}</h3>
                            ${badgeInfo ? `<p class="badge-description">${badgeInfo.description}</p>` : ''}
                            <p class="badge-earned">Earned ${new Date(badge.earnedDate).toLocaleDateString()} Â· Practice #${badge.practiceNumber}</p>
                          </div>
                        </div>
                      `;
                    }).join('') : '<p class="empty">Earned badges show up here. Keep logging.</p>'}
                  </div>
                </article>
              </section>

              <!-- Journey Guide -->
              <section id="section-guide" class="section ${currentTab === 'guide' ? 'active' : ''}">
                <article class="panel">
                  <div class="panel-header">
                    <h2>Journey guide</h2>
                    <p class="panel-subtitle">Phases explain what to expect. No promises, just direction.</p>
                  </div>
                  <div class="guide-grid">
                    ${PHASES.map(phase => `
                      <div class="guide-card">
                        <p class="eyebrow">Phase ${phase.id}</p>
                        <h3>${phase.name}</h3>
                        <p class="guide-goal">Goal: ${phase.goal} logged practices</p>
                        <p class="guide-description">${phase.description}</p>
                      </div>
                    `).join('')}
                  </div>
                </article>
              </section>

              <!-- Settings -->
              <section id="section-settings" class="section ${currentTab === 'settings' ? 'active' : ''}">
                <article class="panel">
                  <div class="panel-header">
                    <h2>Data & settings</h2>
                    <p class="panel-subtitle">Your data stays on-device. Export for backups, clear when needed.</p>
                  </div>
                  <div class="settings-actions">
                    <button id="export-btn" class="button secondary">Export JSON</button>
                    <button id="clear-btn" class="button danger">Clear all data</button>
                  </div>
                  <div class="settings-import">
                    <label for="import-file">Import saved data</label>
                    <input type="file" id="import-file" accept="application/json" class="input">
                    <button id="import-btn" class="button ghost">Import JSON</button>
                  </div>
                  <p class="settings-note">Clearing data removes every practice and badge. There are no take-backs.</p>
                </article>
              </section>
            </main>
          </div>
        `;

        // --- Event Listeners ---
        document.getElementById('practice-form').addEventListener('submit', handleAddPractice);
        document.getElementById('practice-intensity').addEventListener('input', () => updateSliderValue('intensity'));
        document.getElementById('practice-physical').addEventListener('input', () => updateSliderValue('physical'));
        document.getElementById('practice-mental').addEventListener('input', () => updateSliderValue('mental'));
        document.querySelectorAll('.tab').forEach(btn => btn.addEventListener('click', switchTab));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeletePractice));
        document.querySelectorAll('.chip').forEach(btn => btn.addEventListener('click', handleDurationPreset));
        document.querySelectorAll('[data-switch-to]').forEach(btn => btn.addEventListener('click', quickSwitch));
        const heroButton = document.getElementById('hero-log-btn');
        if (heroButton) {
          heroButton.addEventListener('click', () => {
            currentTab = 'log';
            render();
          });
        }

        // Settings Listeners
        document.getElementById('export-btn').addEventListener('click', handleExportData);
        document.getElementById('clear-btn').addEventListener('click', handleClearData);
        document.getElementById('import-btn').addEventListener('click', handleImportData);

        // Initial slider values
        updateSliderValue('intensity');
        updateSliderValue('physical');
        updateSliderValue('mental');
      }
      
      // --- HANDLERS ---
      function updateSliderValue(name) {
        document.getElementById(`${name}-value`).textContent = document.getElementById(`practice-${name}`).value;
      }
      
      function handleDurationPreset(e) {
          document.getElementById('practice-duration').value = e.target.dataset.duration;
      }

      function quickSwitch(e) {
        const target = e.currentTarget.getAttribute('data-switch-to');
        if (target) {
          currentTab = target;
          render();
        }
      }

      async function handleAddPractice(e) {
        e.preventDefault();
        const notes = document.getElementById('practice-notes').value.trim();
        const duration = parseInt(document.getElementById('practice-duration').value) || 0;
        const type = document.getElementById('practice-type').value;
        const intensity = parseInt(document.getElementById('practice-intensity').value);
        const physical = parseInt(document.getElementById('practice-physical').value);
        const mental = parseInt(document.getElementById('practice-mental').value);
        const date = document.getElementById('practice-date').value;
        
        if (!notes || duration <= 0) {
            alert("Please provide notes and a valid duration.");
            return;
        }

        const newPractice = {
            id: Date.now(), 
            notes, 
            duration, 
            type,
            intensity, 
            physical, 
            mental, 
            date
        };
        
        await dbAddPractice(newPractice);
        
        // Clear the form
        document.getElementById('practice-form').reset();
        document.getElementById('practice-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('practice-intensity').value = 5;
        document.getElementById('practice-physical').value = 5;
        document.getElementById('practice-mental').value = 5;

        // Switch to Dashboard and re-render
        currentTab = 'dashboard';
        render();
      }

      function switchTab(e) {
        currentTab = e.target.id.split('-')[1];
        render();
      }

      async function handleDeletePractice(e) {
        const id = parseInt(e.target.dataset.id);
        
        if (confirm("Are you sure you want to delete this practice log?")) {
            await dbDeletePractice(id);
            // Re-render to update history and stats
            render();
        }
      }
      
      function handleExportData() {
        // Collect all data
        const data = {
            practices: practices,
            profile: profile,
            exportDate: new Date().toISOString()
        };
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wrestling_journey_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function handleClearData() {
          if (confirm("THIS IS PERMANENT. Are you absolutely sure you want to clear ALL practice logs, badges, and progress?")) {
              await clearAllData();
              currentTab = 'dashboard';
              alert("All data cleared!");
              render();
          }
      }

      function handleImportData() {
          const fileInput = document.getElementById('import-file');
          const file = fileInput.files[0];
          if (!file) {
              alert("Please select a JSON file to import.");
              return;
          }

          const reader = new FileReader();
          reader.onload = async (e) => {
              try {
                  const importedData = JSON.parse(e.target.result);
                  if (importedData.practices && importedData.profile) {
                      // Simple implementation: delete all current and insert imported
                      await clearAllData();
                      
                      for (const p of importedData.practices) {
                          await dbAddPractice(p);
                      }
                      await setProfile(importedData.profile);
                      
                      currentTab = 'dashboard';
                      alert("Data imported successfully! Rendering...");
                      render();
                  } else {
                      alert("Invalid file format. Must contain 'practices' and 'profile' arrays/objects.");
                  }
              } catch (error) {
                  alert("Error parsing JSON file: " + error.message);
              }
          };
          reader.readAsText(file);
      }

      // --- AI Prompt Generation (Needs update for TRUTH_DOC) ---
      function generatePrompt() {
        const lastPractice = practices.length > 0 ? practices.slice(-1)[0] : null;
        let basePrompt = "Generate a short, motivational prompt for a wrestler based on their training log. The tone should be coach-like, direct, and slightly challenging. Focus on the 'Reflect' section of the prompt.";
        
        if (lastPractice) {
            basePrompt += ` The last practice was on ${new Date(lastPractice.date).toLocaleDateString()}, focusing on ${lastPractice.type} with ${lastPractice.intensity}/10 intensity. Notes: "${lastPractice.notes.substring(0, 100)}..."`;
        } else {
            basePrompt += " The wrestler is just starting out, encourage them to log their first session.";
        }

        const promptTemplate = [
            "**Goal:** Define a single, measurable objective for your next session.",
            "**Drill:** Pick one technique from your notes and drill it 50 times perfectly.",
            "**Reflect:** Visualize your biggest weakness from the last session. What one thing would have changed the outcome?"
        ];

        return `
            **AI-Ready Prompt Generator (Copy Below to AI Chat)**
            ---
            ${basePrompt}
            ---
            **Template:**
            ${promptTemplate.join('\n')}
        `;
      }
      
      function handleGeneratePrompt() {
          // This function is no longer needed as the prompt is generated on render, 
          // but if we were to move the Motivate section to its own screen, it would be used here.
      }

      render();
    });
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>