<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initi        import { openDB, addPractice, getPractices, deletePractice, getProfile, setProfile, clearAllData, ALL_BADGES, checkBadges, PHASES, getPhase, IDENTITY_LEVELS, getCurrentIdentityLevel, getIdentityProgress, MILESTONES } from '../docs/db.js';
        
        // Make functions available globally for tests
        window.openDB = openDB;cale=1.0">
    <meta name="theme-color" content="#ea580c">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Wrestling PWA - Test Suite</title>
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg">
    <link rel="apple-touch-icon" href="../docs/icon.svg">
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
        }
        .test-results {
            margin: 20px 0;
        }
        .test-group {
            margin: 20px 0;
            padding: 10px;
            border-left: 4px solid #666;
        }
        .test-group.pass {
            border-left-color: #4CAF50;
        }
        .test-group.fail {
            border-left-color: #f44336;
        }
        .test-case {
            margin: 5px 0;
            padding: 5px;
        }
        .test-case.pass {
            color: #4CAF50;
        }
        .test-case.fail {
            color: #f44336;
        }
        .test-case.pending {
            color: #ff9800;
        }
        .summary {
            margin-top: 30px;
            padding: 15px;
            background: #333;
            border-radius: 5px;
        }
        .run-tests {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .run-tests:hover {
            background: #45a049;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>Wrestling PWA Test Suite</h1>
    <p>Testing harness for vanilla JS PWA functionality</p>

    <button class="run-tests" onclick="runAllTests()">Run All Tests</button>
    <button class="run-tests" onclick="copyFailedTests()" id="copyFailedBtn" style="display: none; background: #f44336;">Copy Failed Tests</button>

    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="test-results" id="testResults">
        <p>Click "Run All Tests" to start testing...</p>
    </div>

    <!-- Mock DOM elements for form tests -->
    <div style="display: none;">
        <form id="practice-form">
            <select id="practice-type">
                <option value="drills">Drills/Technique</option>
                <option value="live">Live Sparring/Rolling</option>
                <option value="conditioning">Conditioning/Strength</option>
                <option value="competition">Competition</option>
            </select>
            <input id="practice-date" type="date">
            <input id="practice-duration" type="number" min="1">
            <input id="practice-intensity" type="range" min="1" max="10" value="5">
            <span id="intensity-value">5</span>
            <input id="practice-physical" type="range" min="1" max="5" value="3">
            <span id="physical-value">3</span>
            <input id="practice-mental" type="range" min="1" max="5" value="3">
            <span id="mental-value">3</span>
            <textarea id="practice-notes"></textarea>
            <button type="button" class="preset-btn" data-duration="60">60</button>
            <button type="button" class="preset-btn" data-duration="90">90</button>
            <button type="button" class="preset-btn" data-duration="120">120</button>
        </form>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h2>Test Summary</h2>
        <p id="summaryText"></p>
    </div>

    <!-- Load test framework -->
    <script src="test-framework.js"></script>

    <!-- Load db.js for database tests -->
    <script type="module">
        import { openDB, addPractice, getPractices, deletePractice, getProfile, setProfile, clearAllData, ALL_BADGES, checkBadges, PHASES, getPhase } from '../docs/db.js?v=4';
        
        // Make functions available globally for tests
        window.openDB = openDB;
        window.addPractice = addPractice;
        window.getPractices = getPractices;
        window.deletePractice = deletePractice;
        window.getProfile = getProfile;
        window.setProfile = setProfile;
        window.clearAllData = clearAllData;
        window.ALL_BADGES = ALL_BADGES;
        window.checkBadges = checkBadges;
        window.PHASES = PHASES;
        window.getPhase = getPhase;
        window.IDENTITY_LEVELS = IDENTITY_LEVELS;
        window.getCurrentIdentityLevel = getCurrentIdentityLevel;
        window.getIdentityProgress = getIdentityProgress;
        window.MILESTONES = MILESTONES;
    </script>

    <!-- Load test files -->
    <script src="tests/db-tests.js"></script>
    <script src="tests/pwa-tests.js"></script>
    <script src="tests/form-tests.js"></script>
    <script src="tests/badge-tests.js"></script>

    <script>
        // Form functionality for tests
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('practice-form');
            const durationInput = document.getElementById('practice-duration');
            const intensityInput = document.getElementById('practice-intensity');
            const physicalInput = document.getElementById('practice-physical');
            const mentalInput = document.getElementById('practice-mental');
            const dateInput = document.getElementById('practice-date');
            
            // Set today's date as default
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
            
            // Handle preset duration buttons
            const presetButtons = document.querySelectorAll('.preset-btn');
            presetButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (durationInput) {
                        durationInput.value = this.dataset.duration;
                    }
                });
            });
            
            // Handle slider value updates
            function updateSliderDisplay(slider, displayId) {
                const display = document.getElementById(displayId);
                if (slider && display) {
                    slider.addEventListener('input', function() {
                        display.textContent = this.value;
                    });
                }
            }
            
            updateSliderDisplay(intensityInput, 'intensity-value');
            updateSliderDisplay(physicalInput, 'physical-value');
            updateSliderDisplay(mentalInput, 'mental-value');
            
            // Add form submission handler
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    // Form submission logic would go here
                    return false;
                };
            }
        });

        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            const progressBar = document.getElementById('progressBar');
            const summaryDiv = document.getElementById('summary');
            const copyFailedBtn = document.getElementById('copyFailedBtn');

            resultsDiv.innerHTML = '<p>Running tests...</p>';
            summaryDiv.style.display = 'none';
            copyFailedBtn.style.display = 'none';
            progressBar.style.width = '0%';

            try {
                const results = await TestRunner.runAll();
                window.lastTestResults = results; // Store for copy function
                displayResults(results);
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: #f44336;">Test runner failed: ${error.message}</p>`;
            }
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('testResults');
            const progressBar = document.getElementById('progressBar');
            const summaryDiv = document.getElementById('summary');
            const summaryText = document.getElementById('summaryText');
            const copyFailedBtn = document.getElementById('copyFailedBtn');

            let html = '';
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;

            results.forEach(group => {
                group.tests.forEach(test => {
                    totalTests++;
                    if (test.status === 'pass') passedTests++;
                    if (test.status === 'fail') failedTests++;
                });

                const groupClass = group.failed === 0 ? 'pass' : 'fail';
                html += `<div class="test-group ${groupClass}">`;
                html += `<h3>${group.name}</h3>`;

                group.tests.forEach(test => {
                    const testClass = test.status === 'pass' ? 'pass' : test.status === 'fail' ? 'fail' : 'pending';
                    html += `<div class="test-case ${testClass}">`;
                    html += `<strong>${test.name}:</strong> ${test.status}`;
                    if (test.error) {
                        html += `<br><small style="color: #f44336;">${test.error}</small>`;
                    }
                    html += `</div>`;
                });

                html += `</div>`;
            });

            resultsDiv.innerHTML = html;

            const passRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            summaryText.innerHTML = `Total Tests: ${totalTests}<br>Passed: ${passedTests}<br>Failed: ${failedTests}<br>Pass Rate: ${passRate}%`;
            summaryDiv.style.display = 'block';

            progressBar.style.width = `${passRate}%`;
            progressBar.style.background = passRate === 100 ? '#4CAF50' : passRate >= 70 ? '#ff9800' : '#f44336';

            // Show copy failed tests button if there are failures
            if (failedTests > 0) {
                copyFailedBtn.style.display = 'inline-block';
            }
        }

        async function copyFailedTests() {
            const copyFailedBtn = document.getElementById('copyFailedBtn');

            if (!window.lastTestResults) {
                alert('No test results available. Run tests first.');
                return;
            }

            let failedResults = 'FAILED TEST RESULTS\n';
            failedResults += '=' .repeat(50) + '\n\n';

            let totalFailed = 0;

            window.lastTestResults.forEach(group => {
                const failedTests = group.tests.filter(test => test.status === 'fail');

                if (failedTests.length > 0) {
                    failedResults += `GROUP: ${group.name}\n`;
                    failedResults += '-'.repeat(30) + '\n';

                    failedTests.forEach(test => {
                        totalFailed++;
                        failedResults += `❌ ${test.name}\n`;
                        if (test.error) {
                            failedResults += `   Error: ${test.error}\n`;
                        }
                        failedResults += '\n';
                    });
                }
            });

            failedResults += `TOTAL FAILED: ${totalFailed}\n`;
            failedResults += `TIMESTAMP: ${new Date().toISOString()}\n`;
            failedResults += `USER AGENT: ${navigator.userAgent}\n`;

            try {
                await navigator.clipboard.writeText(failedResults);
                const originalText = copyFailedBtn.textContent;
                copyFailedBtn.textContent = 'Copied!';
                copyFailedBtn.style.background = '#4CAF50';

                setTimeout(() => {
                    copyFailedBtn.textContent = originalText;
                    copyFailedBtn.style.background = '#f44336';
                }, 2000);
            } catch (error) {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = failedResults;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                    const originalText = copyFailedBtn.textContent;
                    copyFailedBtn.textContent = 'Copied!';
                    copyFailedBtn.style.background = '#4CAF50';

                    setTimeout(() => {
                        copyFailedBtn.textContent = originalText;
                        copyFailedBtn.style.background = '#f44336';
                    }, 2000);
                } catch (fallbackError) {
                    alert('Failed to copy to clipboard. Please check browser permissions.');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }
    </script>
</body>
</html>